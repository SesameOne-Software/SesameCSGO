#include "exploits.hpp"
#include "ragebot.hpp"

int queued_shift_amount = 0;
int shifted_counter = 0;
int recharge_delay_counter = 0;

bool exploits::is_recharging ( ) {
	return !recharge_delay_counter && shifted_counter > 0;
}

bool exploits::recharge ( ucmd_t* ucmd ) {
	if ( recharge_delay_counter ) {
		recharge_delay_counter--;
		return false;
	}

	if ( shifted_counter ) {
		ucmd->m_tickcount = INT_MAX;
		shifted_counter--;
		return true;
	}

	return false;
}

void exploits::force_recharge ( int amount, int recharge_delay ) {
	if ( !shifted_counter && !recharge_delay_counter ) {
		shifted_counter = amount;
		recharge_delay_counter = recharge_delay;
	}
}

void exploits::shift_tickbase ( int amount, int recharge_delay ) {
	if ( !shifted_counter && !queued_shift_amount ) {
		recharge_delay_counter = recharge_delay;
		queued_shift_amount = amount;
	}
}

/* CREDITS @CBRS */
void exploits::pack_commands ( ucmd_t* ucmd, int num, bool teleport ) {
	auto net_chan = csgo::i::client_state->net_channel ( );

	if ( !net_chan )
		return;
	
	for ( auto i = 0; i < num; i++ ) {
		auto next_verified_cmd = csgo::i::input->get_verified_cmd ( ucmd->m_cmdnum + 1 );
		auto next_cmd = csgo::i::input->get_cmd ( ucmd->m_cmdnum + 1 );

		/* create next command */
		*next_cmd = *ucmd;

		next_cmd->m_cmdnum++;
		next_cmd->m_hasbeenpredicted = false;
		next_cmd->m_buttons &= ~(1<<0) /* IN_ATTACK */;
		next_cmd->m_buttons &= ~(1<11) /* IN_ATTACK2 */;

		if ( !teleport )
			next_cmd->m_tickcount = INT_MAX;

		next_verified_cmd->m_cmd = *next_cmd;
		next_verified_cmd->m_crc = next_cmd->get_checksum ( );

		/* set from cmd */
		ucmd = next_cmd;

		/* set clientstate shit */
		csgo::i::client_state->choked ( )++;

		net_chan->m_choked_packets++;
		net_chan->m_out_sequence_nr++;
	}

	csgo::i::pred->m_previous_start_frame = -1;
	csgo::i::pred->m_commands_predicted = 0;
}

void exploits::run ( ucmd_t* ucmd ) {
	if ( !shifted_counter && queued_shift_amount ) {
		pack_commands ( ucmd, queued_shift_amount, features::ragebot::active_config.dt_teleport );

		shifted_counter = queued_shift_amount;
		queued_shift_amount = 0;
	}
}